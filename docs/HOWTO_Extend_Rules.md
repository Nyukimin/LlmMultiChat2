# HOWTO: ルールを増やす/強化する

会話の一貫性と品質は `LLM/global_rules.yaml` と各キャラクターの `personas.yaml` によって制御されます。本書では、グローバル/キャラ別のルール追加方法と、実装フックを案内します。

## 1. グローバルルール（全キャラ共通）
対象: `LLM/global_rules.yaml`

主なセクション:
- `response_constraints`: 応答の基本原則（言語/文量/禁止事項など）
- `flow_rules`: 進行ルール（[Next] 指名、ユーザー宛てなど）
- `prompt_template`: 上記を束ねて最終プロンプトを組むテンプレート

追加例（ユーザー宛て/完結文/番号ルールなど）:
```yaml
response_constraints: |
  - 重要: 必ず日本語で、手短に（2〜3文以内）応答してください。
  - 重要: 常に「ユーザー」に宛てて直接話しかけてください。
  - 禁止: 他AIへの呼びかけや、応答中の役職表現の乱用。
  - 言い切り: 文末は終止記号で完結させてください。

flow_rules: |
  - 応答は常にユーザーに向けて完結した文で返してください。
  - 応答末尾で `[Next: INTERNAL_ID]` を必ず指名してください。
```

保存後、即時反映されます（サーバ再起動不要）。

## 2. キャラ固有ルール（ペルソナ）
対象: `LLM/personas.yaml`

例:
```yaml
LUMINA:
  name: "ルミナ"
  system_prompt: |
    - 明るく推進役。曖昧な点はユーザーに確認する。
    - 他のAIの意見は参考にしつつ、最終的な相手はユーザー。
```

## 3. ルール強化とコードフック
- `conversation_loop.py`
  - プロンプト構築: `response_constraints` / `flow_rules` / `prompt_template`
  - 整形: 前置き除去（`remove_preamble`）、短縮（`shorten_text`）、末尾補完（`ensure_sentence_complete`）
- `next_speaker_resolver.py`
  - `[Next: ...]` / `{ "next": "..." }` の抽出・正規化・フォールバック

ルールを追加した際に、整形や分岐の要件が増える場合は、上記コードの該当箇所も合わせて強化してください。

## 4. ベストプラクティス
- 変更は必ずドキュメント化（`docs/`配下）。ルールの意図と例示を残す。
- 禁止事項は具体-抽象の両面で明記（例: "他AIへの呼びかけ禁止" と "ユーザー宛てで話す"）。
- 長文化を避ける。短く厳格なルール + コード側の整形で守らせる。

## 5. テスト観点
- `[Next]` の有/無、自己指名、未登録指名、複数タグ
- ユーザー宛てで完結文になっているか
- 空応答/長すぎる応答の扱い

## 6. ロールバック
- `global_rules.yaml` を元に戻すだけで即時ロールバック可能です。
