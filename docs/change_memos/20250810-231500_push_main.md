# 2025-08-10 push memo

## 概要
- Ingest Mode を「検索先行」フローで安定化。
- 厳格JSON抽出の強化（マーカー/コードフェンス/最外括弧、緩和パーサ）。
- `next_queries` を最大5件・重複排除・日本語化で正規化。
- 不具合修正: `build_extractor_prompt()` の未return を修正。

## 変更ファイル
- LLM/ingest_mode.py
- KB/USAGE.md
- docs/HOWTO_Ingest_Mode.md
- docs/CHANGELOG.md
- （動作確認用）LLM/_tmp_ingest_test.py

## 動作確認（ChatEnv）
- 依存: `pip install -r LLM/requirements.txt`
- DB: `python KB/init_db.py`
- テスト: `python LLM/_tmp_ingest_test.py`

確認ログ抜粋:
```
[log] Search query: 吉沢亮 国宝 映画
[log] Collected JSON from サーチャー
RESULT {"persons": 0, "works": 1, "credits": 2, "external_ids": 0, "unified": 0}
```

## ドキュメント
- `docs/CHANGELOG.md`: 仕様変更（検索先行・next_queries）と不具合修正を追記
- `docs/HOWTO_Ingest_Mode.md`: スキーマに `next_queries` を追記、抽出ルールを明記
- `KB/USAGE.md`: 検索先行フローと抽出ロジックを追記

## 既知の課題/今後
- LLM応答のスキーマ検証（キー必須・型チェック）の導入
- DuckDuckGo検索のレート制御/再試行
- UIログに `next_queries` を表示（フロント可視化）
